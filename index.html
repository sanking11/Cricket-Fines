<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cricket Fines 2025 - Tracker</title>
  
  <!-- Futuristic Cricket Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%2300ff88;stop-opacity:1'/><stop offset='100%' style='stop-color:%2300cc66;stop-opacity:1'/></linearGradient><filter id='glow'><feGaussianBlur stdDeviation='2' result='coloredBlur'/><feMerge><feMergeNode in='coloredBlur'/><feMergeNode in='SourceGraphic'/></feMerge></filter></defs><circle cx='50' cy='50' r='45' fill='%23001a0f' stroke='url(%23g)' stroke-width='3' filter='url(%23glow)'/><text x='50' y='65' font-size='45' text-anchor='middle' fill='url(%23g)' filter='url(%23glow)'>ğŸ</text><circle cx='50' cy='50' r='48' fill='none' stroke='url(%23g)' stroke-width='1' opacity='0.3'/></svg>" type="image/svg+xml">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0d1a14;
      --text:#eafff3;
      --muted:rgba(255,255,255,.75);
      --accent:#00ff88;
      --accent-soft:#7cffb2;
      --danger:#ff4444;
      --stroke: rgba(255,255,255,0.18);
      --card-bg: rgba(255,255,255,0.08);
      --radius: 20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      padding:28px;
      color:var(--text);
      background:#0d1a14;
      font-family:'Rajdhani', 'Exo 2', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      letter-spacing:.3px;
      overflow-x:hidden;
      font-weight:500;
    }
    .animated-bg{
      position:fixed; inset:0; z-index:0;
      background: linear-gradient(135deg,
        #0f2e2e 0%,
        #2a4555 25%,
        #15402a 50%,
        #243b5f 75%,
        #0f2e2e 100%
      );
      background-size:400% 400%;
      animation: gradientShift 18s ease infinite;
    }
    @keyframes gradientShift{
      0%{background-position:0% 50%}
      25%{background-position:50% 75%}
      50%{background-position:100% 50%}
      75%{background-position:50% 25%}
      100%{background-position:0% 50%}
    }

    @keyframes neonBorder{
      0%, 100%{
        border-color: rgba(0,255,136,0.3);
        box-shadow: 0 0 10px rgba(0,255,136,0.2), inset 0 0 10px rgba(0,255,136,0.1);
      }
      50%{
        border-color: rgba(0,255,136,0.8);
        box-shadow: 0 0 20px rgba(0,255,136,0.5), inset 0 0 15px rgba(0,255,136,0.2);
      }
    }

    @keyframes neonGlow{
      0%, 100%{
        box-shadow: 0 0 5px rgba(0,255,136,0.3);
      }
      50%{
        box-shadow: 0 0 15px rgba(0,255,136,0.6);
      }
    }

    .wrap{max-width:1200px; margin:0 auto; position:relative; z-index:2;}
    .row{ display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); }

    @media (max-width: 768px) {
      body { padding: 16px; }
      .wrap { padding: 0; }
      .row { grid-template-columns: 1fr; gap: 12px; }
      h1 { font-size: 24px; letter-spacing: 3px; }
      .card { padding: 16px; }
      table { font-size: 14px; }
      td, th { padding: 8px 6px; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 20px; letter-spacing: 2px; }
      .card { padding: 12px; margin-bottom: 12px; }
      input, select, button { font-size: 14px; padding: 10px; }
    }

    .card{
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: var(--radius);
      border:2px solid rgba(0,255,136,0.3);
      padding:24px;
      margin-bottom:18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 0 40px rgba(0,255,136,0.10);
      position: relative;
      animation: neonBorder 3s ease-in-out infinite;
    }

    h1{
      margin: 0 0 18px;
      font-family: 'Orbitron', sans-serif;
      font-weight:800;
      letter-spacing:6px;
      color: var(--accent);
      text-shadow: 0 0 20px rgba(0,255,136,0.5);
      animation: futuristicGlow 2s ease-in-out infinite;
    }
    @keyframes futuristicGlow{
      0%,100%{
        text-shadow:
          0 0 10px rgba(0,255,136,.8),
          0 0 20px rgba(0,255,136,.6),
          0 0 30px rgba(0,255,136,.4),
          0 0 40px rgba(0,255,136,.2);
        filter: brightness(1);
      }
      50%{
        text-shadow:
          0 0 20px rgba(0,255,136,1),
          0 0 40px rgba(0,255,136,.8),
          0 0 60px rgba(0,255,136,.6),
          0 0 80px rgba(0,255,136,.4),
          0 0 100px rgba(0,255,136,.2);
        filter: brightness(1.15);
      }
    }

    label{display:block; color: var(--accent); margin-bottom:8px; font-weight:600; letter-spacing:1.2px; text-transform:uppercase; font-size:.85em;}
    input, select, button, textarea{
      width:100%; padding:12px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius:10px;
      color:#fff; font-size:16px; transition: all .25s ease;
      font-family:'Rajdhani', sans-serif;
    }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.65); }
    input:focus, select:focus, textarea:focus{
      outline:none; border-color: var(--accent);
      box-shadow: 0 0 20px rgba(0,255,136,0.5);
      background: rgba(255,255,255,0.15);
      animation: neonGlow 2s ease-in-out infinite;
    }

    .btn{ cursor:pointer; border:2px solid var(--accent); background: rgba(255,255,255,0.15); color: var(--accent);
          text-transform: uppercase; font-weight:800; letter-spacing:2px; text-shadow:0 0 10px rgba(0,255,136,0.5); }
    .btn:hover{ background: rgba(0,255,136,0.25); box-shadow:0 0 25px rgba(0,255,136,0.6); transform: translateY(-2px); }
    .btn.primary{ border-color: var(--accent); color: #04110b; background: linear-gradient(180deg, rgba(0,255,136,.9), rgba(0,255,136,.55)); }
    .btn.secondary{ border-color: rgba(255,255,255,0.3); color: #fff; background: rgba(255,255,255,0.1); }
    .btn.danger{ border-color: var(--danger); color: var(--danger); background: rgba(255,68,68,0.2); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    table{ 
      width:100%; 
      border-collapse: collapse; 
      background: rgba(255,255,255,0.05); 
      backdrop-filter: blur(10px); 
      border-radius:15px; 
      overflow:hidden; 
      border: 2px solid rgba(0,255,136,0.3);
      animation: neonBorder 4s ease-in-out infinite;
    }
    
    @media (max-width: 768px) {
      .card > div:has(table) {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      table {
        min-width: 600px;
        font-size: 13px;
      }
      th, td {
        white-space: nowrap;
      }
    }
    th{ background: rgba(255,255,255,0.15); color: var(--accent); padding:15px; text-align:left;
        font-weight:700; font-family:'Orbitron', sans-serif; letter-spacing:1.5px; text-transform:uppercase; font-size:.8em; }
    td{ padding:12px 15px; color:#fff; border-bottom:1px solid rgba(255,255,255,0.1); }
    tr:hover{ background: rgba(255,255,255,0.08); }
    .muted{ color: var(--muted); font-size: .9em; }

    .tag{ font-size: 11px; padding:4px 8px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.2); border-radius:999px; }
    .hidden{ display:none !important; }

    .statusline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .dot{ width:10px; height:10px; border-radius:50%; background: var(--accent); display:inline-block; box-shadow: 0 0 12px currentColor; }

    .locked::after{
      content:"VIEW ONLY â€” sign in as admin to add";
      position:absolute; inset:auto 12px 12px 12px;
      background: linear-gradient(180deg, rgba(7,17,12,.6), rgba(7,17,12,.85));
      border:1px dashed rgba(255,255,255,.35); color: var(--muted);
      padding:10px 12px; border-radius:12px; text-align:center; letter-spacing:.3px;
    }
    .locked .mask{ position:absolute; inset:0; backdrop-filter: blur(4px) saturate(120%); background: rgba(7,17,12,.35); pointer-events:none; }
    .locked .content *{ filter: blur(1px) brightness(.95); pointer-events:none; user-select:none; }
    .player-hidden{ display:none !important; }
    
    .success-banner {
      background: rgba(0,255,136,0.2);
      border: 2px solid var(--accent);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 18px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="animated-bg" aria-hidden="true"></div>

  <div class="wrap">
    <h1>CRICKET FINES TRACKER 2025</h1>
    <p class="muted" style="margin-bottom:16px">Welcome to the club, where cricketers pay for their sins and every dropped catch costs you more than just runs!ğŸğŸ’¸</p>

    <!-- Static Gate -->
    <div class="card" id="gateCard">
      <h3 style="margin:0 0 10px; font-family:'Orbitron', sans-serif; letter-spacing:2px; color:var(--accent)">Enter Shared Password</h3>
      <div class="row">
        <div><label>Password</label><input id="gatePassword" type="password" placeholder="Team password" /></div>
        <button id="gateBtn" class="btn primary" style="align-self:end">Unlock</button>
      </div>
      <p class="muted" style="margin-top:12px; line-height:1.6;">
        ğŸ“ <strong>Don't have the password?</strong> Please check with your captain/coach.<br>
        ğŸ” <strong>Access Levels:</strong> Players can view â€¢ Admin has all rights
      </p>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <!-- Connection status banner -->
      <div id="cloudStatus" class="success-banner hidden">
        <span>âœ…</span>
        <span id="cloudStatusText">Connected to cloud</span>
      </div>
      
      <div class="card">
        <div class="row">
          <div>
            <label>Status</label>
            <div class="statusline">
              <span id="status">Local</span>
              <span id="statusCloud" class="dot hidden"></span>
            </div>
          </div>
          <div id="cloudModeCol" class="player-hidden">
            <label>Cloud Mode</label>
            <select id="cloudMode">
              <option value="local">Local (no cloud)</option>
              <option value="cloud_read">Cloud â€” Read-only</option>
              <option value="cloud_write">Cloud â€” Admin write</option>
            </select>
          </div>
          <div style="align-self:end">
            <label style="display:block; color:var(--muted); margin-bottom:6px; font-size:11px; text-align:center; text-transform:none; letter-spacing:0.5px;">
              ğŸšª Escape the vault? Hit LOCK ğŸ‘‡
            </label>
            <button id="lockBtn" class="btn secondary">Lock</button>
          </div>
        </div>
      </div>

      <div class="card" id="addCard">
        <div class="mask hidden"></div>
        <div class="content">
          <h3 style="margin-top:0; font-family:'Orbitron', sans-serif; letter-spacing:2px; color:var(--accent)">Add Fine</h3>
          <div class="row">
            <div><label>Season</label><input id="season" placeholder="e.g., 2025" /></div>
            <div><label>Player</label><input id="player" placeholder="e.g., Vinit" /></div>
            <div><label>Match</label><input id="match" placeholder="e.g., Match 1 or 2025-05-12" /></div>
            <div><label>Reason</label><input id="reason" placeholder="e.g., Late arrival" /></div>
            <div><label>Amount</label><input id="amount" type="number" step="1" min="0" placeholder="5" /></div>
            <div><label>Paid?</label><select id="paid"><option value="false" selected>No</option><option value="true">Yes</option></select></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="addBtn" class="btn primary">Add fine</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div><label>Filter: Player</label><input id="filterPlayer" placeholder="All players" /></div>
          <div><label>Filter: Match</label><input id="filterMatch" placeholder="All matches" /></div>
          <div><label>Filter: Paid</label><select id="filterPaid"><option value="">All</option><option value="true">Paid</option><option value="false">Unpaid</option></select></div>
          <div style="align-self:end"><button id="clearFilters" class="btn secondary">Clear filters</button></div>
        </div>
      </div>

      <div class="card" style="overflow:auto; max-height: 55vh; -webkit-overflow-scrolling: touch;">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Player</th>
              <th>Match</th>
              <th>Reason</th>
              <th style="text-align:right">Amount</th>
              <th style="text-align:center">Paid?</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h3 style="margin-top:0; font-family:'Orbitron', sans-serif; letter-spacing:2px; color:var(--accent)">Summaries</h3>
        
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:16px; margin-bottom:24px;">
          <div style="padding:20px; background:linear-gradient(135deg, rgba(0,255,136,0.15), rgba(0,255,136,0.05)); border-radius:12px; border:2px solid rgba(0,255,136,0.3); text-align:center;">
            <div style="font-size:11px; color:var(--accent); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:8px; font-weight:600;">ğŸ’° Total Fines</div>
            <div id="totalFines" style="font-size:42px; font-weight:900; color:var(--accent); font-family:'Orbitron', sans-serif; text-shadow:0 0 20px rgba(0,255,136,0.5);">0</div>
          </div>
          
          <div style="padding:20px; background:linear-gradient(135deg, rgba(255,68,68,0.15), rgba(255,68,68,0.05)); border-radius:12px; border:2px solid rgba(255,68,68,0.3); text-align:center;">
            <div style="font-size:11px; color:#ff99a5; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:8px; font-weight:600;">ğŸ”´ Unpaid</div>
            <div id="totalUnpaid" style="font-size:42px; font-weight:900; color:#ff4444; font-family:'Orbitron', sans-serif; text-shadow:0 0 20px rgba(255,68,68,0.5);">0</div>
            <div id="unpaidPercentage" style="font-size:12px; color:#ff99a5; margin-top:4px; font-weight:600;">0%</div>
          </div>
          
          <div style="padding:20px; background:linear-gradient(135deg, rgba(130,245,200,0.15), rgba(130,245,200,0.05)); border-radius:12px; border:2px solid rgba(130,245,200,0.3); text-align:center;">
            <div style="font-size:11px; color:#82f5c8; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:8px; font-weight:600;">ğŸŸ¢ Paid</div>
            <div id="totalPaid" style="font-size:42px; font-weight:900; color:#00ff88; font-family:'Orbitron', sans-serif; text-shadow:0 0 20px rgba(0,255,136,0.5);">0</div>
            <div id="paidPercentage" style="font-size:12px; color:#82f5c8; margin-top:4px; font-weight:600;">0%</div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
          <div>
            <h4 style="margin:0 0 12px; color:var(--accent); font-size:14px; text-transform:uppercase; letter-spacing:1.5px;">ğŸ“Š Totals by Player</h4>
            <div id="totalsByPlayer" style="display:flex; flex-direction:column; gap:6px;"></div>
          </div>
          <div>
            <h4 style="margin:0 0 12px; color:var(--accent); font-size:14px; text-transform:uppercase; letter-spacing:1.5px;">ğŸ Totals by Match</h4>
            <div id="totalsByMatch" style="display:flex; flex-direction:column; gap:6px;"></div>
          </div>
          <div>
            <h4 style="margin:0 0 12px; color:var(--accent); font-size:14px; text-transform:uppercase; letter-spacing:1.5px;">ğŸ¯ By Player Ã— Match</h4>
            <div id="totalsByPlayerMatch" style="display:flex; flex-direction:column; gap:6px;"></div>
          </div>
          <div>
            <h4 style="margin:0 0 12px; color:var(--accent); font-size:14px; text-transform:uppercase; letter-spacing:1.5px;">ğŸ’³ Payment Status by Player</h4>
            <div id="unpaidByPlayer" style="display:flex; flex-direction:column; gap:6px;"></div>
          </div>
        </div>
        
        <style>
          @media (max-width: 768px) {
            .card > div:has(#totalsByPlayer) {
              grid-template-columns: 1fr !important;
            }
          }
        </style>
      </div>

      <div class="card player-hidden">
        <div class="row">
          <button id="exportBtn" class="btn secondary">Export CSV</button>
          <button id="importBtn" class="btn secondary">Import CSV</button>
          <input type="file" id="fileInput" accept=".csv,text/csv" class="hidden" />
          <button id="pullBtn" class="btn secondary">Refresh from Cloud</button>
          <button id="clearAll" class="btn danger">Clear Local Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer style="
    position: relative;
    z-index: 2;
    text-align: center;
    padding: 40px 20px 20px;
    margin-top: 40px;
    border-top: 1px solid rgba(0,255,136,0.2);
  ">
    <div style="
      font-family: 'Rajdhani', sans-serif;
      font-size: 16px;
      color: var(--muted);
      letter-spacing: 0.5px;
    ">
      Designed and Developed by 
      <span style="
        font-family: 'Orbitron', sans-serif;
        font-size: 24px;
        font-weight: 900;
        color: var(--accent);
        text-shadow: 0 0 15px rgba(0,255,136,0.6);
        display: inline-block;
        margin: 0 8px;
        animation: futuristicGlow 2s ease-in-out infinite;
      ">SUNNY</span>
      with lots of love â¤ï¸ coffee â˜• and AI ğŸ‘½ ....
    </div>
    <p style="
      font-family: 'Rajdhani', sans-serif;
      font-size: 16px;
      color: var(--muted);
      letter-spacing: 0.5px;
    ">Inspired by your poor shot selection ğŸ¤£ğŸ¤£ </p>
  </footer>

  <script>
    // ========================================
    // CONFIGURATION - Edit these values
    // ========================================
    const STATIC_PASSWORD_ADMIN  = "TeamFines@2025?";
    const STATIC_PASSWORD_PLAYER = "kumeufines@2025?";
    
    const SUPABASE_URL = "https://zkosstrhmgwvwpbdnqqs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inprb3NzdHJobWd2d3BiZG5xcXMiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTc2MjIxMDEwMSwiZXhwIjoyMDc3Nzg2MTAxfQ.MN2_mhUZZ5x31W_Cn9a1sbw0QFG8XT_8WTP4CTBQTR8";
    const ADMIN_EMAIL = "admin@fake1.lol";
    const PLAYER_EMAIL = "players@fake1.lol";
    
    // ========================================
    // SUPABASE REST API CLIENT (No external library needed!)
    // ========================================
    class SupabaseREST {
      constructor(url, anonKey) {
        this.url = url;
        this.anonKey = anonKey;
        this.accessToken = null;
        this.user = null;
      }
      
      get headers() {
        const h = {
          'apikey': this.anonKey,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        };
        if (this.accessToken) {
          h['Authorization'] = `Bearer ${this.accessToken}`;
        } else {
          h['Authorization'] = `Bearer ${this.anonKey}`;
        }
        return h;
      }
      
      async signIn(email, password) {
        try {
          const res = await fetch(`${this.url}/auth/v1/token?grant_type=password`, {
            method: 'POST',
            headers: {
              'apikey': this.anonKey,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            console.error('Sign in failed:', data);
            return { error: data };
          }
          
          this.accessToken = data.access_token;
          this.user = data.user;
          console.log('âœ… Signed in successfully:', this.user?.email);
          return { data };
        } catch (err) {
          console.error('Sign in error:', err);
          return { error: { message: err.message } };
        }
      }
      
      async signOut() {
        this.accessToken = null;
        this.user = null;
      }
      
      async select(table, options = {}) {
        try {
          let url = `${this.url}/rest/v1/${table}?select=*`;
          if (options.order) {
            url += `&order=${options.order}`;
          }
          
          const res = await fetch(url, {
            method: 'GET',
            headers: this.headers
          });
          
          if (!res.ok) {
            const err = await res.json();
            return { error: err };
          }
          
          const data = await res.json();
          return { data };
        } catch (err) {
          return { error: { message: err.message } };
        }
      }
      
      async upsert(table, row) {
        try {
          const res = await fetch(`${this.url}/rest/v1/${table}`, {
            method: 'POST',
            headers: {
              ...this.headers,
              'Prefer': 'resolution=merge-duplicates,return=representation'
            },
            body: JSON.stringify(row)
          });
          
          if (!res.ok) {
            const err = await res.json();
            console.error('Upsert error:', err);
            return { error: err };
          }
          
          const data = await res.json();
          return { data };
        } catch (err) {
          return { error: { message: err.message } };
        }
      }
      
      async delete(table, column, value) {
        try {
          const res = await fetch(`${this.url}/rest/v1/${table}?${column}=eq.${value}`, {
            method: 'DELETE',
            headers: this.headers
          });
          
          if (!res.ok) {
            const err = await res.json();
            return { error: err };
          }
          
          return { data: true };
        } catch (err) {
          return { error: { message: err.message } };
        }
      }
    }
    
    // Initialize our REST client
    const supabase = new SupabaseREST(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ========================================
    // APP STATE & HELPERS
    // ========================================
    const ROLE_KEY = "fines_role_v1";
    const LS_KEY = "fines_neon_reskin_local_v1";
    const GATE_KEY = "fines_neon_reskin_gate_v1";
    const CLOUD_MODE_KEY = "fines_glass_cloud_mode";

    const $ = (id) => document.getElementById(id);
    
    const canWrite = () => {
      const role = localStorage.getItem(ROLE_KEY);
      const cloudMode = $('cloudMode').value;
      return role === 'admin' && cloudMode === 'cloud_write';
    };
    
    const inCloud = () => $('cloudMode').value.startsWith('cloud');

    function generateUUID() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // ========================================
    // UNLOCK / LOGIN
    // ========================================
    async function unlock(pass) {
      if (!pass) { 
        alert('Please enter a password'); 
        return; 
      }
      
      console.log('ğŸ” Attempting unlock...');
      
      if (pass === STATIC_PASSWORD_ADMIN) {
        console.log('âœ… Admin password matched!');
        localStorage.setItem(ROLE_KEY, 'admin');
        localStorage.setItem(GATE_KEY, pass);
        localStorage.setItem(CLOUD_MODE_KEY, 'cloud_write');
        
        // Try to sign in to Supabase
        const { error } = await supabase.signIn(ADMIN_EMAIL, pass);
        if (error) {
          console.warn('âš ï¸ Supabase auth failed, but continuing:', error.message || error.error_description);
        }
        
        // Load data from cloud
        await pull();
        showApp(true);
        return;
      }
      
      if (pass === STATIC_PASSWORD_PLAYER) {
        console.log('âœ… Player password matched!');
        localStorage.setItem(ROLE_KEY, 'player');
        localStorage.setItem(GATE_KEY, pass);
        localStorage.setItem(CLOUD_MODE_KEY, 'cloud_read');
        
        // Try to sign in to Supabase
        const { error } = await supabase.signIn(PLAYER_EMAIL, pass);
        if (error) {
          console.warn('âš ï¸ Supabase auth failed, but continuing:', error.message || error.error_description);
        }
        
        // Load data from cloud
        await pull();
        showApp(true);
        return;
      }
      
      alert('âŒ Wrong password. Please try again.');
    }

    function showApp(yes) { 
      $('gateCard').classList[yes ? 'add' : 'remove']('hidden'); 
      $('app').classList[yes ? 'remove' : 'add']('hidden'); 
      
      if (yes) { 
        const role = localStorage.getItem(ROLE_KEY);
        
        // Show admin elements
        if (role === 'admin') {
          document.querySelectorAll('.player-hidden').forEach(el => el.style.display = '');
        }
        
        // Set cloud mode dropdown
        const cloudMode = localStorage.getItem(CLOUD_MODE_KEY) || 'local';
        $('cloudMode').value = cloudMode;
        
        // Show cloud status
        if (supabase.user) {
          $('cloudStatus').classList.remove('hidden');
          $('cloudStatusText').textContent = `Connected as ${supabase.user.email}`;
        }
        
        updateStatus();
        render(getData());
      }
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    $('gateBtn').addEventListener('click', async () => await unlock($('gatePassword').value));
    $('gatePassword').addEventListener('keydown', async (e) => { 
      if (e.key === 'Enter') { 
        e.preventDefault(); 
        await unlock($('gatePassword').value); 
      } 
    });
    
    $('lockBtn').addEventListener('click', async () => { 
      await supabase.signOut();
      localStorage.removeItem(GATE_KEY); 
      localStorage.removeItem(ROLE_KEY);
      localStorage.removeItem(CLOUD_MODE_KEY);
      $('cloudStatus').classList.add('hidden');
      showApp(false); 
    });
    
    $('cloudMode').addEventListener('change', () => { 
      localStorage.setItem(CLOUD_MODE_KEY, $('cloudMode').value); 
      updateStatus(); 
    });

    // ========================================
    // DATA FUNCTIONS
    // ========================================
    function getData() { 
      const r = localStorage.getItem(LS_KEY); 
      try { return r ? JSON.parse(r) : []; } 
      catch { return []; } 
    }
    
    function setData(arr) { 
      localStorage.setItem(LS_KEY, JSON.stringify(arr)); 
      render(arr); 
    }

    async function pull() {
      console.log('ğŸ“¥ Loading data from cloud...');
      const { data, error } = await supabase.select('fines', { order: 'created_at.desc' });
      
      if (error) {
        console.error('Failed to load from cloud:', error);
        alert('Failed to load from cloud: ' + (error.message || JSON.stringify(error)));
        return;
      }
      
      const mapped = (data || []).map(r => ({
        id: r.id,
        season: r.season,
        player: r.player,
        match: r.match,
        reason: r.reason,
        amount: Number(r.amount || 0),
        paid: !!r.paid,
        createdAt: r.created_at
      }));
      
      console.log(`âœ… Loaded ${mapped.length} fines from cloud`);
      setData(mapped);
    }

    async function upsertCloud(rec) {
      const row = {
        id: rec.id,
        season: rec.season,
        player: rec.player,
        match: rec.match,
        reason: rec.reason,
        amount: rec.amount,
        paid: rec.paid,
        created_at: rec.createdAt
      };
      
      console.log('ğŸ“¤ Saving to cloud:', row);
      const { data, error } = await supabase.upsert('fines', row);
      
      if (error) {
        console.error('Failed to save:', error);
        alert('Failed to save: ' + (error.message || JSON.stringify(error)));
        return false;
      }
      
      console.log('âœ… Saved successfully');
      return true;
    }

    async function deleteCloud(id) {
      const { error } = await supabase.delete('fines', 'id', id);
      if (error) {
        alert('Failed to delete: ' + (error.message || JSON.stringify(error)));
        return false;
      }
      return true;
    }

    // ========================================
    // UI FUNCTIONS
    // ========================================
    function updateStatus() {
      const role = localStorage.getItem(ROLE_KEY) || 'player';
      
      // Show/hide admin elements
      document.querySelectorAll('.player-hidden').forEach(el => {
        el.style.display = role === 'player' ? 'none' : '';
      });
      
      // Status text
      const parts = [];
      if ($('cloudMode').value === 'local') parts.push('Local');
      else if ($('cloudMode').value === 'cloud_read') parts.push('Cloud read-only');
      else parts.push('Cloud admin');
      
      if (supabase.user) parts.push(`(${supabase.user.email})`);
      
      $('status').textContent = (role === 'admin' ? 'ğŸ‘‘ Admin â€¢ ' : 'ğŸ‘¤ Player â€¢ ') + parts.join(' ');
      $('statusCloud').classList[inCloud() ? 'remove' : 'add']('hidden');

      // Lock cloud mode for players
      if (role === 'player') { 
        $('cloudMode').value = 'cloud_read'; 
        $('cloudMode').disabled = true; 
      } else { 
        $('cloudMode').disabled = false; 
      }

      // Lock/unlock add card
      const addCard = $('addCard');
      const lock = role === 'player' || ($('cloudMode').value !== 'local' && !canWrite());
      
      addCard.classList[lock ? 'add' : 'remove']('locked');
      addCard.querySelector('.mask').classList[lock ? 'remove' : 'add']('hidden');
      addCard.querySelectorAll('input,select,button').forEach(el => el.disabled = lock);

      render(getData());
    }

    function groupBy(arr, fn) { 
      return arr.reduce((m, x) => { 
        const k = fn(x); 
        (m[k] = m[k] || []).push(x); 
        return m; 
      }, {}); 
    }
    
    const fmt = n => (n == null || isNaN(n)) ? "" : "$" + Number(n).toLocaleString(undefined, { maximumFractionDigits: 0 });

    function render(all) {
      const rows = applyFilters(all);
      const tb = document.querySelector('#dataTable tbody');
      tb.innerHTML = '';

      const showDelete = canWrite() || !inCloud();
      
      for (const r of rows) {
        const delCell = showDelete 
          ? `<button class="btn secondary delBtn" data-id="${r.id}">Delete</button>` 
          : `<span class="muted">â€”</span>`;
        const paidToggle = (canWrite() || !inCloud())
          ? `<input type="checkbox" ${r.paid ? 'checked' : ''} data-id="${r.id}" class="paidToggle"/>`
          : `<input type="checkbox" ${r.paid ? 'checked' : ''} disabled/>`;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${r.player || ''}</strong></td>
          <td>${r.match || ''}</td>
          <td>${r.reason || ''}</td>
          <td style="text-align:right">${fmt(r.amount)}</td>
          <td style="text-align:center">${paidToggle}</td>
          <td style="text-align:right">${delCell}</td>`;
        tb.appendChild(tr);
      }

      // Paid toggle handlers
      tb.querySelectorAll('.paidToggle').forEach(cb => {
        cb.addEventListener('change', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const cur = getData().find(x => x.id === id);
          if (!cur) return;
          
          const updated = { ...cur, paid: !cur.paid };
          
          if (inCloud()) {
            await upsertCloud(updated);
            await pull();
          } else {
            setData(getData().map(x => x.id === id ? updated : x));
          }
        });
      });

      // Delete handlers
      tb.querySelectorAll('.delBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          if (!confirm('Delete this fine?')) return;
          
          if (inCloud() && canWrite()) {
            await deleteCloud(id);
            await pull();
          } else {
            setData(getData().filter(x => x.id !== id));
          }
        });
      });

      // Summaries
      const sum = arr => arr.reduce((t, r) => t + (Number(r.amount) || 0), 0);
      const unpaid = arr => arr.filter(r => !r.paid).reduce((t, r) => t + (Number(r.amount) || 0), 0);
      
      const totalAll = sum(rows);
      const totalUnpaidAll = unpaid(rows);
      const totalPaidAll = totalAll - totalUnpaidAll;
      
      const unpaidPercent = totalAll > 0 ? ((totalUnpaidAll / totalAll) * 100).toFixed(1) : 0;
      const paidPercent = totalAll > 0 ? ((totalPaidAll / totalAll) * 100).toFixed(1) : 0;
      
      $('totalFines').textContent = fmt(totalAll);
      $('totalUnpaid').textContent = fmt(totalUnpaidAll);
      $('totalPaid').textContent = fmt(totalPaidAll);
      $('unpaidPercentage').textContent = unpaidPercent + '%';
      $('paidPercentage').textContent = paidPercent + '%';
      
      const byP = groupBy(rows, r => r.player || '');
      const byM = groupBy(rows, r => r.match || '');
      const byPM = groupBy(rows, r => (r.player || '') + ' â€¢ ' + (r.match || ''));
      
      $('totalsByPlayer').innerHTML = Object.entries(byP)
        .sort((a, b) => sum(b[1]) - sum(a[1]))
        .map(([k, v]) => `<div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px; display:flex; justify-content:space-between;"><span>${k || '(blank)'}</span><span style="font-weight:700; color:var(--accent)">${fmt(sum(v))}</span></div>`)
        .join('');
      
      $('totalsByMatch').innerHTML = Object.entries(byM)
        .sort((a, b) => sum(b[1]) - sum(a[1]))
        .map(([k, v]) => `<div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px; display:flex; justify-content:space-between;"><span>${k || '(blank)'}</span><span style="font-weight:700; color:var(--accent)">${fmt(sum(v))}</span></div>`)
        .join('');
      
      $('totalsByPlayerMatch').innerHTML = Object.entries(byPM)
        .sort((a, b) => sum(b[1]) - sum(a[1]))
        .map(([k, v]) => `<div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px; display:flex; justify-content:space-between;"><span style="font-size:13px;">${k || '(blank)'}</span><span style="font-weight:700; color:var(--accent)">${fmt(sum(v))}</span></div>`)
        .join('');
      
      $('unpaidByPlayer').innerHTML = Object.entries(byP)
        .sort((a, b) => unpaid(b[1]) - unpaid(a[1]))
        .map(([k, v]) => {
          const t = sum(v), u = unpaid(v), p = t - u;
          return `<div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px;">
            <div style="font-weight:600; margin-bottom:4px;">${k || '(blank)'}</div>
            <div style="display:flex; gap:12px; font-size:13px;">
              <span style="color:#ff99a5;">Unpaid: <b>${fmt(u)}</b></span>
              <span style="color:#82f5c8;">Paid: <b>${fmt(p)}</b></span>
            </div>
          </div>`;
        }).join('');

      $('statusCloud').classList[inCloud() ? 'remove' : 'add']('hidden');
    }

    function applyFilters(rows) {
      const p = $('filterPlayer').value.trim().toLowerCase();
      const m = $('filterMatch').value.trim().toLowerCase();
      const paid = $('filterPaid').value;
      return rows.filter(r => {
        const a = !p || (r.player || '').toLowerCase().includes(p);
        const b = !m || (r.match || '').toLowerCase().includes(m);
        const c = !paid || String(!!r.paid) === paid;
        return a && b && c;
      });
    }

    // Filter listeners
    $('filterPlayer').addEventListener('input', () => render(getData()));
    $('filterMatch').addEventListener('input', () => render(getData()));
    $('filterPaid').addEventListener('change', () => render(getData()));
    $('clearFilters').addEventListener('click', () => { 
      $('filterPlayer').value = ''; 
      $('filterMatch').value = ''; 
      $('filterPaid').value = ''; 
      render(getData()); 
    });

    // Add fine
    $('addBtn').addEventListener('click', async () => {
      const rec = {
        id: generateUUID(),
        season: $('season').value.trim(),
        player: $('player').value.trim(),
        match: $('match').value.trim(),
        reason: $('reason').value.trim(),
        amount: Number($('amount').value),
        paid: $('paid').value === 'true',
        createdAt: new Date().toISOString()
      };
      
      if (!rec.player) {
        alert('Please enter a player name');
        return;
      }
      
      if (inCloud()) {
        await upsertCloud(rec);
        await pull();
      } else {
        setData(getData().concat([rec]));
      }
      
      $('reason').value = '';
      $('amount').value = '';
      $('reason').focus();
    });

    // Export CSV
    $('exportBtn').addEventListener('click', () => {
      const rows = getData();
      const headers = ["id", "season", "player", "match", "reason", "amount", "paid", "createdAt"];
      const csv = [headers.join(",")].concat(rows.map(r => 
        headers.map(h => {
          const v = r[h] ?? "";
          const need = /[\",\n]/.test(String(v));
          const safe = String(v).replace(/\"/g, '""');
          return need ? `"${safe}"` : safe;
        }).join(",")
      )).join("\n");
      
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "fines.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Import CSV
    $('importBtn').addEventListener('click', () => $('fileInput').click());
    $('fileInput').addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      
      const t = await f.text();
      const [head, ...lines] = t.split(/\r?\n/).filter(Boolean);
      const cols = head.split(",");
      const idx = (h) => cols.indexOf(h);
      const req = ["season", "player", "match", "reason", "amount", "paid"];
      
      if (!req.every(r => idx(r) >= 0)) {
        alert("CSV must include: " + req.join(", "));
        return;
      }
      
      const parsed = lines.map(line => {
        const out = [];
        let cur = '', q = false;
        for (let i = 0; i < line.length; i++) {
          const c = line[i];
          if (c == '"') {
            if (q && line[i + 1] == '"') { cur += '"'; i++; }
            else { q = !q; }
          } else if (c == ',' && !q) {
            out.push(cur);
            cur = '';
          } else {
            cur += c;
          }
        }
        out.push(cur);
        
        const g = (h) => (out[idx(h)] ?? '').replace(/^\"|\"$/g, '');
        return {
          id: generateUUID(),
          season: g('season'),
          player: g('player'),
          match: g('match'),
          reason: g('reason'),
          amount: Number(g('amount') || 0),
          paid: String(g('paid')).toLowerCase() === 'true',
          createdAt: new Date().toISOString()
        };
      });
      
      if (inCloud()) {
        for (const r of parsed) await upsertCloud(r);
        await pull();
      } else {
        setData(getData().concat(parsed));
      }
      
      e.target.value = '';
      alert('Import complete!');
    });

    // Pull from cloud
    $('pullBtn').addEventListener('click', pull);

    // Clear local data
    $('clearAll').addEventListener('click', () => {
      if (!confirm('Clear all local data?')) return;
      localStorage.removeItem(LS_KEY);
      render([]);
    });

    // ========================================
    // INIT
    // ========================================
    // Seed example data if empty
    if (getData().length === 0) {
      setData([
        { id: generateUUID(), season: "2025", player: "Vinit", match: "Match 1", reason: "Late arrival", amount: 5, paid: false, createdAt: new Date().toISOString() },
        { id: generateUUID(), season: "2025", player: "Vinit", match: "Match 1", reason: "Missing gear", amount: 5, paid: false, createdAt: new Date().toISOString() },
        { id: generateUUID(), season: "2025", player: "Vinit", match: "Match 2", reason: "Late", amount: 5, paid: true, createdAt: new Date().toISOString() },
        { id: generateUUID(), season: "2025", player: "Vinit", match: "Match 2", reason: "Arguing", amount: 6, paid: false, createdAt: new Date().toISOString() }
      ]);
    }

    // Check if already unlocked
    (async () => {
      const savedPass = localStorage.getItem(GATE_KEY);
      if (savedPass && (savedPass === STATIC_PASSWORD_ADMIN || savedPass === STATIC_PASSWORD_PLAYER)) {
        await unlock(savedPass);
      }
    })();
  </script>
</body>
</html>
