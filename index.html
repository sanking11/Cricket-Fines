<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cricket Fines 2025 - Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0d1a14;
      --text:#eafff3;
      --muted:rgba(255,255,255,.75);
      --accent:#00ff88;
      --accent-soft:#7cffb2;
      --danger:#ff4444;
      --stroke: rgba(255,255,255,0.18);
      --card-bg: rgba(255,255,255,0.08);
      --radius: 20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      padding:28px;
      color:var(--text);
      background:#0d1a14;
      font-family:'Rajdhani', 'Exo 2', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      letter-spacing:.3px;
      overflow-x:hidden;
      font-weight:500;
    }
    /* Animated Gradient Background from your design */
    .animated-bg{
      position:fixed; inset:0; z-index:0;
      background: linear-gradient(135deg,
        #0f2e2e 0%,
        #2a4555 25%,
        #15402a 50%,
        #243b5f 75%,
        #0f2e2e 100%
      );
      background-size:400% 400%;
      animation: gradientShift 18s ease infinite;
    }
    @keyframes gradientShift{
      0%{background-position:0% 50%}
      25%{background-position:50% 75%}
      50%{background-position:100% 50%}
      75%{background-position:50% 25%}
      100%{background-position:0% 50%}
    }

    @keyframes neonBorder{
      0%, 100%{
        border-color: rgba(0,255,136,0.3);
        box-shadow: 0 0 10px rgba(0,255,136,0.2), inset 0 0 10px rgba(0,255,136,0.1);
      }
      50%{
        border-color: rgba(0,255,136,0.8);
        box-shadow: 0 0 20px rgba(0,255,136,0.5), inset 0 0 15px rgba(0,255,136,0.2);
      }
    }

    @keyframes neonGlow{
      0%, 100%{
        box-shadow: 0 0 5px rgba(0,255,136,0.3);
      }
      50%{
        box-shadow: 0 0 15px rgba(0,255,136,0.6);
      }
    }

    .wrap{max-width:1200px; margin:0 auto; position:relative; z-index:2;}
    .row{ display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body { padding: 16px; }
      .wrap { padding: 0; }
      .row { grid-template-columns: 1fr; gap: 12px; }
      h1 { font-size: 24px; letter-spacing: 3px; }
      .card { padding: 16px; }
      table { font-size: 14px; }
      td, th { padding: 8px 6px; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 20px; letter-spacing: 2px; }
      .card { padding: 12px; margin-bottom: 12px; }
      input, select, button { font-size: 14px; padding: 10px; }
    }

    /* Glass container vibe */
    .card{
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: var(--radius);
      border:2px solid rgba(0,255,136,0.3);
      padding:24px;
      margin-bottom:18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 0 40px rgba(0,255,136,0.10);
      position: relative;
      animation: neonBorder 3s ease-in-out infinite;
    }

    h1{
      margin: 0 0 18px;
      font-family: 'Orbitron', sans-serif;
      font-weight:800;
      letter-spacing:6px;
      color: var(--accent);
      text-shadow: 0 0 20px rgba(0,255,136,0.5);
      animation: futuristicGlow 2s ease-in-out infinite;
    }
    @keyframes futuristicGlow{
      0%,100%{
        text-shadow:
          0 0 10px rgba(0,255,136,.8),
          0 0 20px rgba(0,255,136,.6),
          0 0 30px rgba(0,255,136,.4),
          0 0 40px rgba(0,255,136,.2);
        filter: brightness(1);
      }
      50%{
        text-shadow:
          0 0 20px rgba(0,255,136,1),
          0 0 40px rgba(0,255,136,.8),
          0 0 60px rgba(0,255,136,.6),
          0 0 80px rgba(0,255,136,.4),
          0 0 100px rgba(0,255,136,.2);
        filter: brightness(1.15);
      }
    }

    label{display:block; color: var(--accent); margin-bottom:8px; font-weight:600; letter-spacing:1.2px; text-transform:uppercase; font-size:.85em;}
    input, select, button, textarea{
      width:100%; padding:12px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius:10px;
      color:#fff; font-size:16px; transition: all .25s ease;
      font-family:'Rajdhani', sans-serif;
    }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.65); }
    input:focus, select:focus, textarea:focus{
      outline:none; border-color: var(--accent);
      box-shadow: 0 0 20px rgba(0,255,136,0.5);
      background: rgba(255,255,255,0.15);
      animation: neonGlow 2s ease-in-out infinite;
    }

    .btn{ cursor:pointer; border:2px solid var(--accent); background: rgba(255,255,255,0.15); color: var(--accent);
          text-transform: uppercase; font-weight:800; letter-spacing:2px; text-shadow:0 0 10px rgba(0,255,136,0.5); }
    .btn:hover{ background: rgba(0,255,136,0.25); box-shadow:0 0 25px rgba(0,255,136,0.6); transform: translateY(-2px); }
    .btn.primary{ border-color: var(--accent); color: #04110b; background: linear-gradient(180deg, rgba(0,255,136,.9), rgba(0,255,136,.55)); }
    .btn.secondary{ border-color: rgba(255,255,255,0.3); color: #fff; background: rgba(255,255,255,0.1); }
    .btn.danger{ border-color: var(--danger); color: var(--danger); background: rgba(255,68,68,0.2); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    table{ 
      width:100%; 
      border-collapse: collapse; 
      background: rgba(255,255,255,0.05); 
      backdrop-filter: blur(10px); 
      border-radius:15px; 
      overflow:hidden; 
      border: 2px solid rgba(0,255,136,0.3);
      animation: neonBorder 4s ease-in-out infinite;
    }
    
    /* Mobile table wrapper */
    @media (max-width: 768px) {
      .card > div:has(table) {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      table {
        min-width: 600px;
        font-size: 13px;
      }
      th, td {
        white-space: nowrap;
      }
    }
    th{ background: rgba(255,255,255,0.15); color: var(--accent); padding:15px; text-align:left;
        font-weight:700; font-family:'Orbitron', sans-serif; letter-spacing:1.5px; text-transform:uppercase; font-size:.8em; }
    td{ padding:12px 15px; color:#fff; border-bottom:1px solid rgba(255,255,255,0.1); }
    tr:hover{ background: rgba(255,255,255,0.08); }
    .muted{ color: var(--muted); font-size: .9em; }

    .tag{ font-size: 11px; padding:4px 8px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.2); border-radius:999px; }
    .hidden{ display:none !important; }

    .statusline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .dot{ width:10px; height:10px; border-radius:50%; background: var(--accent); display:inline-block; box-shadow: 0 0 12px currentColor; }

    .locked::after{
      content:"VIEW ONLY ‚Äî sign in as admin to add";
      position:absolute; inset:auto 12px 12px 12px;
      background: linear-gradient(180deg, rgba(7,17,12,.6), rgba(7,17,12,.85));
      border:1px dashed rgba(255,255,255,.35); color: var(--muted);
      padding:10px 12px; border-radius:12px; text-align:center; letter-spacing:.3px;
    }
    .locked .mask{ position:absolute; inset:0; backdrop-filter: blur(4px) saturate(120%); background: rgba(7,17,12,.35); pointer-events:none; }
    .locked .content *{ filter: blur(1px) brightness(.95); pointer-events:none; user-select:none; }
    .player-hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="animated-bg" aria-hidden="true"></div>

  <div class="wrap">
    <h1>CRICKET FINES TRACKER 2025</h1>
    <p class="muted" style="margin-bottom:16px">Where every dropped catch costs you more than just runs! üèèüí∏</p>

    <!-- Static Gate -->
    <div class="card" id="gateCard">
      <h3 style="margin:0 0 10px; font-family:'Orbitron', sans-serif; letter-spacing:2px; color:var(--accent)">Enter Shared Password</h3>
      <div class="row">
        <div><label>Password</label><input id="gatePassword" type="password" placeholder="Team password" /></div>
        <button id="gateBtn" class="btn primary" style="align-self:end">Unlock</button>
      </div>
      <p class="muted" style="margin-top:12px; line-height:1.6;">
        üìû <strong>Don't have the password?</strong> Please check with your captain/coach.<br>
        üîê <strong>Access Levels:</strong> Players can view ‚Ä¢ Admin has all rights ‚Ä¢ Logins are securely controlled by Cloud Authentication.
      </p>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <div class="card">
        <div class="row">
          <div>
            <label>Status</label>
            <div class="statusline">
              <span id="status">Local</span>
              <span id="statusCloud" class="dot hidden"></span>
              <span id="statusRealtime" class="dot hidden"></span>
            </div>
          </div>
          <div id="cloudModeCol" class="player-hidden">
            <label>Cloud Mode</label>
            <select id="cloudMode">
              <option value="local">Local (no cloud)</option>
              <option value="cloud_read">Cloud ‚Äî Read-only</option>
              <option value="cloud_write">Cloud ‚Äî Admin write</option>
            </select>
          </div>
          <div id="realtimeModeCol" class="player-hidden">
            <label>Realtime</label>
            <select id="realtimeMode">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>
          <div style="align-self:end">
            <label style="display:block; color:var(--muted); margin-bottom:6px; font-size:11px; text-align:center; text-transform:none; letter-spacing:0.5px;">
              üö™ Escape the vault? Hit LOCK üëá
            </label>
            <button id="lockBtn" class="btn secondary">Lock</button>
          </div>
        </div>
      </div>

      <div class="card player-hidden" id="settingsCard">
        <h3 style="margin-top:0; font-family:'Orbitron', sans-serif; letter-spacing:2px; color:var(--accent)">Supabase Settings</h3>
        <div class="row">
          <div><label>Project URL</label><input id="supabaseUrl" placeholder="https://YOUR-PROJECT.supabase.co" readonly /></div>
          <div><label>Anon Key</label><input id="supabaseKey" placeholder="ey..." readonly /></div>
          <div><label>Auth Email</label><input id="authEmail" placeholder="player@team or admin@team" readonly /></div>
          <div><label>Auth Password</label><input id="authPass" type="password" placeholder="(auto-filled from gate)" readonly /></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="saveSettings" class="btn secondary">Save Settings</button>
          <button id="authSignIn" class="btn primary">Supabase Sign In</button>
          <button id="authSignOut" class="btn secondary">Sign Out</button>
          <button id="pullBtn" class="btn secondary">Load from Cloud</button>
          <button id="pushBtn" class="btn secondary">Push to Cloud (overwrite)</button>
        </div>
        <p class="muted">‚úì Supabase is pre-configured and auto-connects when you unlock with your password. Credentials are read-only for security.</p>
      </div>

      <div class="card" id="addCard">
        <div class="mask hidden"></div>
        <div class="content">
          <h3 style="margin-top:0; font-family:'Orbitron', sans-serif; letter-spacing:2px; color:var(--accent)">Add Fine</h3>
          <div class="row">
            <div><label>Season</label><input id="season" placeholder="e.g., 2025" /></div>
            <div><label>Player</label><input id="player" placeholder="e.g., Vinit" /></div>
            <div><label>Match</label><input id="match" placeholder="e.g., Match 1 or 2025-05-12" /></div>
            <div><label>Reason</label><input id="reason" placeholder="e.g., Late arrival" /></div>
            <div><label>Amount</label><input id="amount" type="number" step="1" min="0" placeholder="5" /></div>
            <div><label>Paid?</label><select id="paid"><option value="false" selected>No</option><option value="true">Yes</option></select></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="addBtn" class="btn primary">Add fine</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div><label>Filter: Player</label><input id="filterPlayer" placeholder="All players" /></div>
          <div><label>Filter: Match</label><input id="filterMatch" placeholder="All matches" /></div>
          <div><label>Filter: Paid</label><select id="filterPaid"><option value="">All</option><option value="true">Paid</option><option value="false">Unpaid</option></select></div>
          <div style="align-self:end"><button id="clearFilters" class="btn secondary">Clear filters</button></div>
        </div>
      </div>

      <div class="card" style="overflow:auto; max-height: 55vh; -webkit-overflow-scrolling: touch;">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Player</th>
              <th>Match</th>
              <th>Reason</th>
              <th style="text-align:right">Amount</th>
              <th style="text-align:center">Paid?</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h3 style="margin-top:0; font-family:'Orbitron', sans-serif; letter-spacing:2px; color:var(--accent)">Summaries</h3>
        
        <!-- Overall Stats -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:16px; margin-bottom:24px;">
          <!-- Total Fines -->
          <div style="padding:20px; background:linear-gradient(135deg, rgba(0,255,136,0.15), rgba(0,255,136,0.05)); border-radius:12px; border:2px solid rgba(0,255,136,0.3); text-align:center;">
            <div style="font-size:11px; color:var(--accent); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:8px; font-weight:600;">üí∞ Total Fines</div>
            <div id="totalFines" style="font-size:42px; font-weight:900; color:var(--accent); font-family:'Orbitron', sans-serif; text-shadow:0 0 20px rgba(0,255,136,0.5);">0</div>
          </div>
          
          <!-- Unpaid -->
          <div style="padding:20px; background:linear-gradient(135deg, rgba(255,68,68,0.15), rgba(255,68,68,0.05)); border-radius:12px; border:2px solid rgba(255,68,68,0.3); text-align:center;">
            <div style="font-size:11px; color:#ff99a5; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:8px; font-weight:600;">üî¥ Unpaid</div>
            <div id="totalUnpaid" style="font-size:42px; font-weight:900; color:#ff4444; font-family:'Orbitron', sans-serif; text-shadow:0 0 20px rgba(255,68,68,0.5);">0</div>
            <div id="unpaidPercentage" style="font-size:12px; color:#ff99a5; margin-top:4px; font-weight:600;">0%</div>
          </div>
          
          <!-- Paid -->
          <div style="padding:20px; background:linear-gradient(135deg, rgba(130,245,200,0.15), rgba(130,245,200,0.05)); border-radius:12px; border:2px solid rgba(130,245,200,0.3); text-align:center;">
            <div style="font-size:11px; color:#82f5c8; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:8px; font-weight:600;">üü¢ Paid</div>
            <div id="totalPaid" style="font-size:42px; font-weight:900; color:#00ff88; font-family:'Orbitron', sans-serif; text-shadow:0 0 20px rgba(0,255,136,0.5);">0</div>
            <div id="paidPercentage" style="font-size:12px; color:#82f5c8; margin-top:4px; font-weight:600;">0%</div>
          </div>
        </div>

        <!-- Breakdown by category -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
          <div>
            <h4 style="margin:0 0 12px; color:var(--accent); font-size:14px; text-transform:uppercase; letter-spacing:1.5px;">üìä Totals by Player</h4>
            <div id="totalsByPlayer" style="display:flex; flex-direction:column; gap:6px;"></div>
          </div>
          <div>
            <h4 style="margin:0 0 12px; color:var(--accent); font-size:14px; text-transform:uppercase; letter-spacing:1.5px;">üèè Totals by Match</h4>
            <div id="totalsByMatch" style="display:flex; flex-direction:column; gap:6px;"></div>
          </div>
          <div>
            <h4 style="margin:0 0 12px; color:var(--accent); font-size:14px; text-transform:uppercase; letter-spacing:1.5px;">üéØ By Player √ó Match</h4>
            <div id="totalsByPlayerMatch" style="display:flex; flex-direction:column; gap:6px;"></div>
          </div>
          <div>
            <h4 style="margin:0 0 12px; color:var(--accent); font-size:14px; text-transform:uppercase; letter-spacing:1.5px;">üí≥ Payment Status by Player</h4>
            <div id="unpaidByPlayer" style="display:flex; flex-direction:column; gap:6px;"></div>
          </div>
        </div>
        
        <style>
          @media (max-width: 768px) {
            .card > div:has(#totalsByPlayer) {
              grid-template-columns: 1fr !important;
            }
          }
        </style>
      </div>

      <div class="card player-hidden">
        <div class="row">
          <button id="exportBtn" class="btn secondary">Export CSV</button>
          <button id="importBtn" class="btn secondary">Import CSV</button>
          <input type="file" id="fileInput" accept=".csv,text/csv" class="hidden" />
          <button id="clearAll" class="btn danger">Clear Local Data</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======= Static gate passwords (obfuscated) =======
    const _a = atob("VGVhbUZpbmVzQDIwMjU/");
    const _b = atob("a3VtZXVmaW5lc0AyMDI1Pw==");
    const STATIC_PASSWORD_ADMIN  = _a;
    const STATIC_PASSWORD_PLAYER = _b;
    const ROLE_KEY = "fines_role_v1";
    
    // ======= Supabase Configuration (obfuscated) =======
    const _c = atob("aHR0cHM6Ly96a29zc3RyaG1nd3Z3cGJkbnFxcy5zdXBhYmFzZS5jbw==");
    const _d = atob("ZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKemRYQmhZbUZ6WlNJc0luSmxaaUk2SW5wcmIzTnpkSEpvYldkM2RuZHdZbVJ1Y1hGeklpd2ljbTlzWlNJNkltRnViMjRpTENKcFlYUWlPakUzTmpJeU1UQXhNREVzSW1WNGNDSTZNakEzTnpjNE5qRXdNWDAuTU4yX21oVVpaNXgzMVdfQ245YTFzYncwUUZHOFhUXzhXVFA0Q1RCUVRSOA==");
    const _e = atob("YWRtaW5AZmFrZTEubG9s");
    const _f = atob("cGxheWVyc0BmYWtlMS5sb2w=");
    
    const SUPABASE_URL = _c;
    const SUPABASE_ANON_KEY = _d;
    const ADMIN_EMAIL = _e;
    const PLAYER_EMAIL = _f;
    // =============================================================================

    // Local keys
    const LS_KEY="fines_neon_reskin_local_v1", SET_KEY="fines_neon_reskin_settings_v1", GATE_KEY="fines_neon_reskin_gate_v1";
    const CLOUD_MODE_KEY="fines_glass_cloud_mode", REALTIME_KEY="fines_glass_realtime";

    // Supabase
    let supabase=null, supaAuth=null, realtimeChannel=null;
    let supaCfg={ url: SUPABASE_URL, key: SUPABASE_ANON_KEY };

    const $ = (id)=>document.getElementById(id);
    const canWrite = ()=> {
      const role = localStorage.getItem(ROLE_KEY);
      const cloudMode = $('cloudMode').value;
      // Admin in cloud_write mode can always write (even if Supabase auth fails)
      if(role === 'admin' && cloudMode === 'cloud_write') return true;
      // Otherwise, need proper Supabase auth
      return cloudMode === 'cloud_write' && !!supaAuth?.user;
    };
    const inCloud = ()=> $('cloudMode').value.startsWith('cloud');
    const realtimeOn = ()=> $('realtimeMode').value === 'on';

    // UUID generator that works on HTTP and HTTPS
    function generateUUID() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return generateUUID();
      }
      // Fallback for HTTP (non-secure contexts)
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Unlock gate
    async function unlock(pass){
      if (!pass) { alert('Enter password'); return; }
      
      if (pass === STATIC_PASSWORD_ADMIN){
        // Clear any old settings first
        localStorage.removeItem(CLOUD_MODE_KEY);
        
        localStorage.setItem(ROLE_KEY, 'admin');
        localStorage.setItem(GATE_KEY, pass);
        localStorage.setItem(CLOUD_MODE_KEY, 'cloud_write');
        
        console.log('Admin unlock: cloud mode set to:', localStorage.getItem(CLOUD_MODE_KEY));
        
        // Auto-setup Supabase
        await setupSupabase();
        
        console.log('Supabase setup complete, supabase object:', !!supabase);
        
        // Auto-login to Supabase
        if(supabase) {
          console.log('Attempting Supabase login with:', ADMIN_EMAIL, 'password length:', pass.length);
          try {
            const { data, error } = await supabase.auth.signInWithPassword({ 
              email: ADMIN_EMAIL, 
              password: pass 
            });
            if(error) {
              console.error('‚ùå Supabase login failed:', error);
              console.error('Error details:', JSON.stringify(error, null, 2));
              alert('Supabase Authentication Failed!\n\nError: ' + error.message + '\n\nPlease check:\n1. User exists in Supabase Auth\n2. Password is correct: ' + pass + '\n3. Email confirmation (if required)');
            } else {
              console.log('‚úÖ Supabase login successful!', data);
              alert('‚úÖ Successfully logged into Supabase!');
              // Load data from cloud
              await pull();
            }
          } catch(err) {
            console.error('‚ùå Supabase login exception:', err);
            alert('Supabase login error: ' + err.message);
          }
        } else {
          console.error('‚ùå Supabase object not initialized');
          alert('Warning: Could not initialize Supabase. Check console for errors.');
        }
        
        showApp(true);
        return;
      }
      
      if (pass === STATIC_PASSWORD_PLAYER){
        localStorage.setItem(ROLE_KEY, 'player');
        localStorage.setItem(GATE_KEY, pass);
        localStorage.setItem(CLOUD_MODE_KEY, 'cloud_read');
        
        // Auto-setup Supabase
        await setupSupabase();
        
        // Auto-login to Supabase
        if(supabase) {
          const { error } = await supabase.auth.signInWithPassword({ 
            email: PLAYER_EMAIL, 
            password: pass 
          });
          if(error) {
            console.error('Supabase login failed:', error.message);
            alert('Warning: Could not connect to cloud. Some features may be limited.');
          } else {
            // Load data from cloud
            await pull();
          }
        }
        
        showApp(true);
        return;
      }
      
      alert('Wrong password');
    }

    function showApp(yes){ 
      $('gateCard').classList[yes?'add':'remove']('hidden'); 
      $('app').classList[yes?'remove':'add']('hidden'); 
      if(yes){ 
        // First, make sure admin elements are visible
        const role = localStorage.getItem(ROLE_KEY);
        if(role === 'admin') {
          document.querySelectorAll('.player-hidden').forEach(el => el.style.display = '');
        }
        
        // Then load settings which will set the dropdown value
        loadSettings(); 
        render(getData()); 
        
        // Force unlock Add Fine card for admin
        if(role === 'admin') {
          const addCard = $('addCard');
          addCard.classList.remove('locked');
          const mask = addCard.querySelector('.mask');
          if(mask) mask.classList.add('hidden');
          addCard.querySelectorAll('input,select,button').forEach(el => { el.disabled = false; });
        }
        
        // Update status after a small delay to ensure cloud mode is set
        setTimeout(() => updateStatus(), 100);
      }
    }

    $('gateBtn').addEventListener('click', async ()=> await unlock($('gatePassword').value));
    $('gatePassword').addEventListener('keydown', async (e)=>{ if(e.key==='Enter'){ e.preventDefault(); await unlock($('gatePassword').value); } });
    $('lockBtn').addEventListener('click', async ()=>{ 
      if(supabase) await supabase.auth.signOut();
      localStorage.removeItem(GATE_KEY); 
      localStorage.removeItem('fines_role_v1'); 
      showApp(false); 
    });
    
    // Check if already unlocked on page load
    (async ()=>{ 
      const s=localStorage.getItem(GATE_KEY); 
      if(s && (s === STATIC_PASSWORD_ADMIN || s === STATIC_PASSWORD_PLAYER)) {
        await unlock(s);
      }
    })();

    // Settings
    function saveSettings(){
      supaCfg={ url:$('supabaseUrl').value.trim(), key:$('supabaseKey').value.trim() };
      const pack={ ...supaCfg, email:$('authEmail').value.trim()? $('authEmail').value.trim():null };
      localStorage.setItem(SET_KEY, JSON.stringify(pack));
      localStorage.setItem(CLOUD_MODE_KEY, $('cloudMode').value);
      localStorage.setItem(REALTIME_KEY, $('realtimeMode').value);
      setupSupabase();
    }
    function loadSettings(){
      // Always use hardcoded Supabase credentials
      supaCfg.url = SUPABASE_URL;
      supaCfg.key = SUPABASE_ANON_KEY;
      $('supabaseUrl').value = supaCfg.url;
      $('supabaseKey').value = supaCfg.key;
      
      // Set email based on role
      const role = localStorage.getItem(ROLE_KEY);
      if(role === 'admin') {
        $('authEmail').value = ADMIN_EMAIL;
      } else if(role === 'player') {
        $('authEmail').value = PLAYER_EMAIL;
      }
      
      // CRITICAL: Set dropdown to match localStorage
      const cloudMode = localStorage.getItem(CLOUD_MODE_KEY) || 'local';
      const realtimeMode = localStorage.getItem(REALTIME_KEY) || 'off';
      
      console.log('loadSettings - setting dropdown to:', cloudMode);
      $('cloudMode').value = cloudMode;
      $('realtimeMode').value = realtimeMode;
      console.log('loadSettings - dropdown is now:', $('cloudMode').value);
      
      updateStatus();
    }
    $('saveSettings').addEventListener('click', saveSettings);

    async function setupSupabase(){
      if(supaCfg.url && supaCfg.key){
        // Load Supabase library if not already loaded
        if(!window.supabase) {
          try {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
            script.type = 'text/javascript';
            await new Promise((resolve, reject) => {
              script.onload = resolve;
              script.onerror = reject;
              document.head.appendChild(script);
            });
            // Wait for supabase to be available
            await new Promise(resolve => setTimeout(resolve, 100));
          } catch(err) {
            console.error('Failed to load Supabase library:', err);
            alert('Failed to load cloud library. Please refresh the page.');
            return;
          }
        }
        
        const { createClient } = window.supabase;
        supabase = createClient(supaCfg.url, supaCfg.key);
        supaAuth = supabase.auth;
      } else { 
        supabase=null; 
        supaAuth=null; 
      }
      manageRealtime();
      updateStatus();
    }
    
    // Initialize Supabase on page load
    setupSupabase();

    // Auth
    $('authSignIn').addEventListener('click', async()=>{
      if(!supabase){ alert('Supabase not initialized. Check console for errors.'); return; }
      
      const role = localStorage.getItem(ROLE_KEY);
      const gatePass = localStorage.getItem(GATE_KEY);
      
      let email, password;
      if(role === 'admin') {
        email = ADMIN_EMAIL;
        password = gatePass || STATIC_PASSWORD_ADMIN;
      } else if(role === 'player') {
        email = PLAYER_EMAIL;
        password = gatePass || STATIC_PASSWORD_PLAYER;
      } else {
        alert('Please login first');
        return;
      }
      
      console.log('Manual sign-in attempt with:', email);
      
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){ 
        console.error('Sign-in error:', error);
        alert('Sign-in failed!\n\n' + error.message + '\n\nCheck:\n- User exists in Supabase\n- Correct credentials\n- Email confirmed'); 
        return; 
      }
      
      console.log('Sign-in successful!', data);
      alert('‚úì Successfully signed in to Supabase!');
      updateStatus();
      if(inCloud()) await pull();
    });
    $('authSignOut').addEventListener('click', async()=>{
      if(supabase){ await supabase.auth.signOut(); }
      updateStatus();
    });

    // Mode toggles
    $('cloudMode').addEventListener('change', ()=>{ localStorage.setItem(CLOUD_MODE_KEY, $('cloudMode').value); updateStatus(); });
    $('realtimeMode').addEventListener('change', ()=>{ localStorage.setItem(REALTIME_KEY, $('realtimeMode').value); manageRealtime(); updateStatus(); });

    function updateStatus(){
      const role = localStorage.getItem('fines_role_v1') || 'player';
      
      console.log('updateStatus called - Role:', role, 'localStorage cloudMode:', localStorage.getItem(CLOUD_MODE_KEY), 'dropdown value:', $('cloudMode').value);
      
      // Show/hide admin-only elements
      const playerHiddenElements = document.querySelectorAll('.player-hidden');
      playerHiddenElements.forEach(el => {
        if(role === 'player') {
          el.style.display = 'none';
        } else {
          el.style.display = '';
        }
      });
      
      const parts=[];
      if($('cloudMode').value==='local'){ parts.push('Local'); }
      else if($('cloudMode').value==='cloud_read'){ parts.push('Cloud read'); }
      else { parts.push('Cloud admin write'); }
      if(supaAuth?.user){ parts.push(`Signed in: ${$('authEmail').value||supaAuth.user.email||'user'}`); }
      $('status').textContent = (role==='admin' ? 'Admin ‚Ä¢ ' : 'Player ‚Ä¢ ') + parts.join(' ‚Ä¢ ');
      $('statusCloud').classList[inCloud()?'remove':'add']('hidden');
      $('statusRealtime').classList[realtimeOn()&&inCloud()?'remove':'add']('hidden');

      if(role==='player'){ 
        $('cloudMode').value='cloud_read'; 
        $('cloudMode').setAttribute('disabled','disabled'); 
      } else { 
        $('cloudMode').removeAttribute('disabled'); 
      }

      const addCard = $('addCard');
      // Players always locked
      // Admin: unlocked in local mode, locked in cloud modes unless can write
      let lock = false;
      if(role === 'player') {
        lock = true;
      } else if(role === 'admin') {
        if($('cloudMode').value === 'local') {
          lock = false; // Admin can always add in local mode
        } else {
          lock = !canWrite(); // In cloud mode, need proper auth to write
        }
      }
      
      console.log('Lock status - Role:', role, 'Cloud Mode:', $('cloudMode').value, 'Lock:', lock, 'canWrite:', canWrite());
      
      addCard.classList[lock?'add':'remove']('locked');
      addCard.querySelector('.mask').classList[lock?'remove':'add']('hidden');
      addCard.querySelectorAll('input,select,button').forEach(el => { el.disabled = lock; });

      render(getData());
    }

    async function manageRealtime(){
      if(!supabase || !realtimeOn() || !inCloud()){ if(realtimeChannel){ await realtimeChannel.unsubscribe(); realtimeChannel=null; } return; }
      if(realtimeChannel) return;
      realtimeChannel = supabase
        .channel('public:fines-changes')
        .on('postgres_changes',{ event:'*', schema:'public', table:'fines' }, async ()=>{ await pull(); })
        .subscribe();
    }

    // Data
    function getData(){ const r=localStorage.getItem(LS_KEY); try{ return r? JSON.parse(r):[] }catch{ return [] } }
    function setData(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); render(arr); }

    function groupBy(a, f){ return a.reduce((m,x)=>{ const k=f(x); (m[k]??=[]).push(x); return m; },{}); }
    const fmt = n => (n==null||isNaN(n))? "" : "$" + Number(n).toLocaleString(undefined,{maximumFractionDigits:0});

    function render(all){
      const rows = applyFilters(all);
      const tb = document.querySelector('#dataTable tbody'); tb.innerHTML='';

      const showDelete = canWrite() || !inCloud(); // hide delete in cloud read-only
      for(const r of rows){
        const delCell = showDelete ? `<button class="btn secondary delBtn" data-id="${r.id}">Delete</button>` : `<span class="muted">‚Äî</span>`;
        const paidToggle = (canWrite() || !inCloud())
          ? `<input type="checkbox" ${r.paid?'checked':''} data-id="${r.id}" class="paidToggle"/>`
          : `<input type="checkbox" ${r.paid?'checked':''} disabled/>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${r.player||''}</strong></td>
          <td>${r.match||''}</td>
          <td>${r.reason||''}</td>
          <td style="text-align:right">${fmt(r.amount)}</td>
          <td style="text-align:center">${paidToggle}</td>
          <td style="text-align:right">${delCell}</td>`;
        tb.appendChild(tr);
      }

      tb.querySelectorAll('.paidToggle').forEach(cb=> {
        cb.addEventListener('change', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const cur = getData().find(x=>x.id===id); 
          if(!cur) {
            console.error('Could not find fine with id:', id);
            return;
          }
          
          const patch = { paid: !cur.paid };
          const updatedRecord = { ...cur, ...patch };
          
          console.log('Toggling paid status:', id, 'New value:', patch.paid, 'canWrite:', canWrite(), 'inCloud:', inCloud());
          
          if(inCloud()) {
            // In cloud mode - try to update Supabase
            console.log('Updating Supabase...');
            await upsertCloud(updatedRecord);
            await pull(); // Refresh from cloud
            console.log('Supabase updated and data refreshed');
          } else {
            // Local mode - update localStorage
            console.log('Updating localStorage...');
            setData(getData().map(x=>x.id===id ? updatedRecord : x));
          }
        });
      });
      tb.querySelectorAll('.delBtn').forEach(btn=> {
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          if(!confirm('Delete this fine?')) return;
          if(canWrite()){ await deleteCloud(id); await pull(); } else { setData(getData().filter(x=>x.id!==id)); }
        });
      });

      // Summaries
      const sum = arr => arr.reduce((t,r)=> t+(Number(r.amount)||0), 0);
      const unpaid = arr => arr.filter(r=>!r.paid).reduce((t,r)=> t+(Number(r.amount)||0), 0);
      
      // Overall totals
      const totalAll = sum(rows);
      const totalUnpaidAll = unpaid(rows);
      const totalPaidAll = totalAll - totalUnpaidAll;
      
      // Calculate percentages
      const unpaidPercent = totalAll > 0 ? ((totalUnpaidAll / totalAll) * 100).toFixed(1) : 0;
      const paidPercent = totalAll > 0 ? ((totalPaidAll / totalAll) * 100).toFixed(1) : 0;
      
      document.getElementById('totalFines').textContent = fmt(totalAll);
      document.getElementById('totalUnpaid').textContent = fmt(totalUnpaidAll);
      document.getElementById('totalPaid').textContent = fmt(totalPaidAll);
      document.getElementById('unpaidPercentage').textContent = unpaidPercent + '%';
      document.getElementById('paidPercentage').textContent = paidPercent + '%';
      
      // Breakdowns
      const byP = groupBy(rows, r=> r.player||'');
      const byM = groupBy(rows, r=> r.match||'');
      const byPM = groupBy(rows, r=> (r.player||'')+' ‚Ä¢ '+(r.match||''));
      
      document.getElementById('totalsByPlayer').innerHTML = Object.entries(byP).sort((a,b)=>sum(b[1])-sum(a[1])).map(([k,v])=> `<div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px; display:flex; justify-content:space-between; align-items:center;"><span>${k||'(blank)'}</span><span style="font-weight:700; color:var(--accent)">${fmt(sum(v))}</span></div>`).join('');
      
      document.getElementById('totalsByMatch').innerHTML = Object.entries(byM).sort((a,b)=>sum(b[1])-sum(a[1])).map(([k,v])=> `<div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px; display:flex; justify-content:space-between; align-items:center;"><span>${k||'(blank)'}</span><span style="font-weight:700; color:var(--accent)">${fmt(sum(v))}</span></div>`).join('');
      
      document.getElementById('totalsByPlayerMatch').innerHTML = Object.entries(byPM).sort((a,b)=>sum(b[1])-sum(a[1])).map(([k,v])=> `<div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px; display:flex; justify-content:space-between; align-items:center;"><span style="font-size:13px;">${k||'(blank)'}</span><span style="font-weight:700; color:var(--accent)">${fmt(sum(v))}</span></div>`).join('');
      
      document.getElementById('unpaidByPlayer').innerHTML = Object.entries(byP).sort((a,b)=>unpaid(b[1])-unpaid(a[1])).map(([k,v])=> {
        const t=sum(v), u=unpaid(v), p=t-u;
        return `<div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px;">
          <div style="font-weight:600; margin-bottom:4px;">${k||'(blank)'}</div>
          <div style="display:flex; gap:12px; font-size:13px;">
            <span style="color:#ff99a5;">Unpaid: <b>${fmt(u)}</b></span>
            <span style="color:#82f5c8;">Paid: <b>${fmt(p)}</b></span>
          </div>
        </div>`;
      }).join('');

      document.getElementById('statusCloud').classList[inCloud()?'remove':'add']('hidden');
      document.getElementById('statusRealtime').classList[realtimeOn()&&inCloud()?'remove':'add']('hidden');
    }

    function applyFilters(rows){
      const p=$('filterPlayer').value.trim().toLowerCase();
      const m=$('filterMatch').value.trim().toLowerCase();
      const paid=$('filterPaid').value;
      return rows.filter(r=>{
        const a=!p || (r.player||'').toLowerCase().includes(p);
        const b=!m || (r.match||'').toLowerCase().includes(m);
        const c=!paid || String(!!r.paid)===paid;
        return a && b && c;
      });
    }
    $('filterPlayer').addEventListener('input', ()=>render(getData()));
    $('filterMatch').addEventListener('input', ()=>render(getData()));
    $('filterPaid').addEventListener('change', ()=>render(getData()));
    $('clearFilters').addEventListener('click', ()=>{ $('filterPlayer').value=''; $('filterMatch').value=''; $('filterPaid').value=''; render(getData()); });

    // Add
    $('addBtn').addEventListener('click', ()=> addN(1));
    async function addN(n){
      const rec = ()=>({ id: generateUUID(), season:$('season').value.trim(), player:$('player').value.trim(), match:$('match').value.trim(), reason:$('reason').value.trim(), amount:Number($('amount').value), paid: $('paid').value==='true', createdAt:new Date().toISOString() });
      if(inCloud() && !canWrite()){ alert('Cloud write disabled for this account/mode.'); return; }
      for(let i=0;i<n;i++){
        const r = rec();
        if(inCloud()){ await upsertCloud(r); } else { setData(getData().concat([r])); }
      }
      if(inCloud()) await pull();
      $('reason').value=''; $('amount').value=''; $('reason').focus();
    }

    // CSV
    $('exportBtn').addEventListener('click', ()=>{
      const rows=getData(), headers=["id","season","player","match","reason","amount","paid","createdAt"];
      const csv=[headers.join(",")].concat(rows.map(r=> headers.map(h=>{
        const v=r[h]??""; const need=/[\",\n]/.test(String(v)); const safe=String(v).replace(/\"/g,'\"\"'); return need?`\"${safe}\"`:safe;
      }).join(","))).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}), url=URL.createObjectURL(blob), a=document.createElement('a'); a.href=url; a.download="fines.csv"; a.click(); URL.revokeObjectURL(url);
    });
    $('importBtn').addEventListener('click', ()=> $('fileInput').click());
    $('fileInput').addEventListener('change', async (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const t=await f.text(); const [head,...lines]=t.split(/\r?\n/).filter(Boolean);
      const cols=head.split(",");
      const idx=(h)=> cols.indexOf(h);
      const req=["season","player","match","reason","amount","paid"];
      if(!req.every(r=> idx(r)>=0)){ alert("CSV must include: "+req.join(", ")); return; }
      const parsed=lines.map(line=>{
        const out=[]; let cur='', q=false; for(let i=0;i<line.length;i++){ const c=line[i]; if(c=='\"'){ if(q&&line[i+1]=='\"'){ cur+='\"'; i++; } else { q=!q; } } else if(c==',' && !q){ out.push(cur); cur=''; } else { cur+=c; } } out.push(cur);
        const g=(h)=> (out[idx(h)]??'').replace(/^\"|\"$/g,'');
        return { id: generateUUID(), season:g('season'), player:g('player'), match:g('match'), reason:g('reason'), amount:Number(g('amount')||0), paid:String(g('paid')).toLowerCase()==='true', createdAt:new Date().toISOString() };
      });
      if(inCloud()){ for(const r of parsed) await upsertCloud(r); await pull(); } else { setData(getData().concat(parsed)); }
      e.target.value=''; alert('Import complete.');
    });
    $('pullBtn').addEventListener('click', pull);
    $('pushBtn').addEventListener('click', async ()=>{
      if(!supabase){ alert('Add Supabase settings'); return; }
      if(!canWrite()){ alert('Sign in as admin & choose Cloud ‚Äî Admin write'); return; }
      if(!confirm('Replace ALL rows in cloud with local data?')) return;
      const { error: delErr } = await supabase.from('fines').delete().neq('id','00000000-0000-0000-0000-000000000000');
      if(delErr){ alert('Wipe failed: '+delErr.message); return; }
      const rows = getData().map(r=> ({ id:r.id, season:r.season, player:r.player, match:r.match, reason:r.reason, amount:r.amount, paid:r.paid, created_at:r.createdAt }));
      for(let i=0;i<rows.length;i+=500){ const chunk=rows.slice(i,i+500); const { error } = await supabase.from('fines').insert(chunk); if(error){ alert('Insert failed: '+error.message); return; } }
      await pull(); alert('Cloud overwritten.');
    });

    // Cloud helpers
    async function pull(){
      if(!supabase){ alert('Add Supabase settings'); return; }
      const { data, error } = await supabase.from('fines').select('*').order('created_at',{ascending:false});
      if(error){ alert('Load failed: '+error.message); return; }
      const mapped=(data||[]).map(r=> ({ id:r.id, season:r.season, player:r.player, match:r.match, reason:r.reason, amount:Number(r.amount||0), paid:!!r.paid, createdAt:r.created_at }));
      setData(mapped);
    }
    async function upsertCloud(rec){
      if(!supabase){ 
        console.error('Supabase not initialized');
        alert('Supabase not connected. Cannot save to cloud.'); 
        return; 
      }
      
      const row = { id:rec.id, season:rec.season, player:rec.player, match:rec.match, reason:rec.reason, amount:rec.amount, paid:rec.paid, created_at:rec.createdAt };
      console.log('Upserting to Supabase:', row);
      
      const { data, error } = await supabase.from('fines').upsert(row).select();
      
      if(error){ 
        console.error('Supabase upsert error:', error);
        alert('Save failed: '+error.message); 
      } else {
        console.log('‚úÖ Successfully saved to Supabase:', data);
      }
    }
    async function deleteCloud(id){
      if(!supabase){ alert('Add Supabase settings'); return; }
      const { error } = await supabase.from('fines').delete().eq('id', id);
      if(error){ alert('Delete failed: '+error.message); }
    }

    // Seed example if empty
    if(getData().length===0){
      setData([
        { id: generateUUID(), season:"2025", player:"Vinit", match:"Match 1", reason:"Late arrival", amount:5, paid:false, createdAt:new Date().toISOString() },
        { id: generateUUID(), season:"2025", player:"Vinit", match:"Match 1", reason:"Missing gear", amount:5, paid:false, createdAt:new Date().toISOString() },
        { id: generateUUID(), season:"2025", player:"Vinit", match:"Match 2", reason:"Late", amount:5, paid:true, createdAt:new Date().toISOString() },
        { id: generateUUID(), season:"2025", player:"Vinit", match:"Match 2", reason:"Arguing", amount:6, paid:false, createdAt:new Date().toISOString() }
      ]);
    }
  </script>
</body>
</html>
